#!/bin/bash

# Pre-commit hook for netbird-api-exporter
# This script runs formatting, linting, and tests before allowing a commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    exit 1
fi

# Get the list of staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "â„¹ï¸  No Go files staged for commit"
    exit 0
fi

echo "ğŸ“‹ Staged Go files:"
echo "$STAGED_GO_FILES"
echo

# Run go fmt
echo "ğŸ¨ Running go fmt..."
if ! make fmt; then
    echo "âŒ go fmt failed"
    exit 1
fi
echo "âœ… go fmt passed"
echo

# Check if fmt made any changes to staged files
MODIFIED_FILES=$(git diff --name-only $STAGED_GO_FILES || true)
if [ -n "$MODIFIED_FILES" ]; then
    echo "âš ï¸  The following files were modified by go fmt:"
    echo "$MODIFIED_FILES"
    echo "Please stage these changes and commit again."
    exit 1
fi

# Run linting
echo "ğŸ”§ Running lint..."
if ! make lint; then
    echo "âŒ Linting failed"
    echo "Please fix the linting issues before committing."
    exit 1
fi
echo "âœ… Linting passed"
echo

# Run tests
echo "ğŸ§ª Running tests..."
if ! make test; then
    echo "âŒ Tests failed"
    echo "Please fix the failing tests before committing."
    exit 1
fi
echo "âœ… Tests passed"
echo

echo "ğŸ‰ All pre-commit checks passed! Proceeding with commit..." 